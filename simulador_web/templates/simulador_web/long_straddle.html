<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Long Straddle – Screener</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 16px;
            background: #f5f5f5;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 8px;
        }
        .card {
            background: #ffffff;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        .form-row label {
            font-size: 13px;
            display: block;
            margin-bottom: 2px;
        }
        .form-row input,
        .form-row select {
            padding: 4px 6px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid #ccc;
            min-width: 90px;
        }
        .btn {
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 6px;
            border: none;
            background: #2563eb;
            color: #fff;
            cursor: pointer;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            padding: 4px 6px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        th {
            background: #f3f4f6;
            text-align: right;
        }
        th:first-child, td:first-child {
            text-align: left;
        }
        .text-right {
            text-align: right;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
            background: #e5e7eb;
        }
        .erro {
            color: #b91c1c;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .aviso {
            color: #92400e;
            font-size: 12px;
            margin-top: 6px;
        }
    </style>
</head>
<body>

<div class="card">
    <h1>Long Straddle – Screener ATM</h1>

    {% if erro %}
        <div class="erro">{{ erro }}</div>
    {% endif %}

    <form method="get">
        <div class="form-row">
            <div>
                <label for="id_ativo">Ativo</label>
                <input type="text" id="id_ativo" name="ativo" value="{{ ativo }}" placeholder="PETR4">
            </div>
            <div>
                <label for="id_lote_total">Lote Total</label>
                <input type="number" id="id_lote_total" name="lote_total" value="{{ lote_total }}">
            </div>
            <div>
                <label for="id_horizonte">Horizonte</label>
                <select id="id_horizonte" name="horizonte">
                    <option value="Vencimento" {% if horizonte == "Vencimento" %}selected{% endif %}>Vencimento</option>
                    <option value="D+1" {% if horizonte == "D+1" %}selected{% endif %}>D+1</option>
                </select>
            </div>
            <div>
                <label for="id_crush_iv">Crush IV (%)</label>
                <input
                    type="number"
                    step="0.1"
                    id="id_crush_iv"
                    name="crush_iv"
                    value="{{ crush_iv }}"
                >
            </div>
            <div style="align-self:flex-end;">
                <button class="btn" type="submit" id="btn_rodar">Rodar screener</button>
            </div>
        </div>

        {% if spot_oficial %}
            <div style="font-size: 12px; margin-top: 4px;">
                Spot oficial: <strong>{{ spot_oficial|floatformat:2 }}</strong>
            </div>
        {% endif %}

        {% if aviso_horizonte %}
            <div class="aviso">{{ aviso_horizonte }}</div>
        {% endif %}

        <!-- status de processamento (preenchido via JS ao enviar o form) -->
        <div id="status_msg" class="aviso"></div>
    </form>
</div>

{% if linhas_screener %}
<div class="card" id="resultado_card">
    <table>
        <thead>
        <tr>
            <th style="text-align:center;">CALL</th>
            <th style="text-align:center;">PUT</th>
            <th>Strike</th>
            <th>%BE↓</th>
            <th>BE↓</th>
            <th>%BE↑</th>
            <th>BE↑</th>
            <th>Spot</th>
            <th>Prêmio Total</th>
            <th>Prêmio CALL</th>
            <th>Δ CALL</th>
            <th>Prêmio PUT</th>
            <th>Δ PUT</th>
            <th>Vencimento</th>
            <th>Lote CALL</th>
            <th>Lote PUT</th>
            <th>Custo Operação</th>
        </tr>
        </thead>
        <tbody>
        {% for r in linhas_screener %}
            <tr>
                <td>{{ r.call }}</td>
                <td>{{ r.put }}</td>
                <td class="text-right">
                    {{ r.strike|floatformat:2 }}
                </td>

                {# %BE↓ e %BE↑ – 2 casas + símbolo % #}
                <td class="text-right">
                    {% if r.be_pct_down is not None %}
                        {{ r.be_pct_down|floatformat:2 }}%
                    {% endif %}
                </td>
                <td class="text-right">
                    {{ r.be_down|floatformat:2 }}
                </td>
                <td class="text-right">
                    {% if r.be_pct_up is not None %}
                        {{ r.be_pct_up|floatformat:2 }}%
                    {% endif %}
                </td>
                <td class="text-right">
                    {{ r.be_up|floatformat:2 }}
                </td>

                <td class="text-right">
                    {{ spot_oficial|default_if_none:r.spot|floatformat:2 }}
                </td>

                <td class="text-right">
                    R$ {{ r.premium_total|floatformat:4 }}
                </td>
                <td class="text-right">
                    R$ {{ r.call_premio|floatformat:4 }}
                </td>
                <td class="text-right">
                    {% if r.call_delta is not None %}
                        {{ r.call_delta|floatformat:4 }}
                    {% endif %}
                </td>
                <td class="text-right">
                    R$ {{ r.put_premio|floatformat:4 }}
                </td>
                <td class="text-right">
                    {% if r.put_delta is not None %}
                        {{ r.put_delta|floatformat:4 }}
                    {% endif %}
                </td>
                <td>{{ r.due_date }}</td>
                <td class="text-right">
                    {{ r.qty_call }}
                </td>
                <td class="text-right">
                    {{ r.qty_put }}
                </td>
                <td class="text-right">
                    R$ {{ r.custo_operacao|floatformat:2 }}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        const btn = document.getElementById("btn_rodar");
        const horiz = document.getElementById("id_horizonte");
        const crush = document.getElementById("id_crush_iv");
        const status = document.getElementById("status_msg");

        function syncCrushField() {
            if (!horiz || !crush) return;
            if (horiz.value === "D+1") {
                // habilita e garante default 10 se estiver vazio
                crush.disabled = false;
                if (!crush.value) {
                    crush.value = "10";
                }
            } else {
                // desabilita, mas NÃO apaga o valor (fica cinza, igual Flet)
                crush.disabled = true;
            }
        }

        // estado inicial ao carregar a página
        syncCrushField();

        if (horiz) {
            horiz.addEventListener("change", function () {
                syncCrushField();
            });
        }

        if (form && btn) {
            form.addEventListener("submit", function () {
                // mensagem visual de processamento
                if (status) {
                    status.textContent = "Processando screener...";
                }
                btn.disabled = true;
                btn.textContent = "Processando...";

                // limpa resultado anterior enquanto processa (efeito parecido com Flet)
                const card = document.getElementById("resultado_card");
                if (card) {
                    card.style.opacity = "0.3";
                }
            });
        }
    });
</script>

</body>
</html>
